import{r as x,j as a}from"./iframe-Bt4UvEqW.js";import{G as U}from"./iconBase-ou9WzbwP.js";import{u as E}from"./index.esm-ClsO7imu.js";import"./ConfirmDeleteModal-BXHaXOST.js";import{B as R,a as z,b as B}from"./Button-40eEdaHr.js";import{u as D}from"./ButtonNavigation-DuwpFPZD.js";import"./Dropdown-D_2yar06.js";import{F as $}from"./FilePicker-D62rdBOg.js";import{V as A,b as L,c as b,u as q}from"./index-BlSK3dwA.js";import{I as S}from"./Input-Bygz4nLz.js";import"./Like-DXxARhTn.js";import"./Loader-ld3rHLDK.js";import"./index-DfYkHRSD.js";import"./PageLoader-HUM1dPua.js";import"./PageWrapper-Nh9y5AVa.js";import"./Text-IhfjRFJQ.js";import"./TrackControlButton-DKEqXBy9.js";import"./UserAvatar-B3tKy1se.js";import{v as y}from"./v4-BKrj-4V8.js";import{g as H}from"./getAudioDuration-BkZTS1fg.js";import{u as O}from"./useTranslation-D6XLV_9q.js";function G(e){return e.name.replace(/\.[^/.]+$/,"")}const V=e=>decodeURIComponent(e).split("/").pop()?.replace(/\.[^/.]+$/,"")??"Untitled";async function J(e){if(!e.groupName)throw A.error("Группа не выбрана"),new Error("groupName is required");return await A.promise((async()=>{const r=new FormData;r.append("groupName",e.groupName),r.append("title",e.title),e.description&&r.append("description",e.description),r.append("cover",e.cover),e.tracks.forEach(({file:p})=>{r.append("tracks",p,p.name)});const l=L.post("/uploadAlbum",r,{headers:{"Content-Type":"multipart/form-data"}}),s=b.get(`/groups?name=${encodeURIComponent(e.groupName)}`),[g,m]=await Promise.all([l,s]),i=g.data,n=m.data[0]?.id;if(!n)throw new Error("Группа не найдена");const c=y(),t={id:c,name:e.title,groupId:n,cover:i.coverUrl,description:e.description??"",createdAt:new Date().toISOString(),trackIds:[]};await b.post("/albums",t);const h=i.tracksUrls.map(async(p,F)=>{const k={id:y(),title:e.tracks[F].title||V(p),duration:e.tracks[F].duration,cover:i.coverUrl,groupName:e.groupName,albumId:c,groupId:n,audioUrl:p,createdAt:new Date().toISOString()},{data:w}=await b.post("/tracks",k);return w.id}),o=await Promise.all(h);return await b.patch(`/albums/${c}`,{trackIds:o}),i})(),{loading:"Создание альбома...",success:"Альбом и треки успешно загружены",error:r=>r instanceof Error?r.message:"Ошибка при создании альбома"})}function M(e){return U({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M408 96H252.11a23.89 23.89 0 0 1-13.31-4L211 73.41A55.77 55.77 0 0 0 179.89 64H104a56.06 56.06 0 0 0-56 56v24h416c0-30.88-25.12-48-56-48zm15.75 352H88.25a56 56 0 0 1-55.93-55.15L16.18 228.11v-.28A48 48 0 0 1 64 176h384.1a48 48 0 0 1 47.8 51.83v.28l-16.22 164.74A56 56 0 0 1 423.75 448zm56.15-221.45z"},child:[]}]})(e)}function K(){const{register:e,handleSubmit:r,watch:l,setValue:s,clearErrors:g,formState:{errors:m}}=E(),i=q(u=>u.currentGroup?.name||""),[n,c]=x.useState(null),[t,h]=x.useState(null),[o,p]=x.useState([]),k=!!l("folder")?.length,[w,C]=x.useState(""),I=D();x.useEffect(()=>{e("folder",{required:"folderRequired"}),e("title"),e("description")},[e]);const T=(u,N)=>{if(!u?.length)return;g(["folder","title"]),s("folder",u,{shouldValidate:!0}),C(N??"");const v=Array.from(u),f=v.find(d=>/cover\.(jpe?g|png|gif|webp)$/i.test(d.name))??v.find(d=>/\.(jpe?g|png|gif|webp)$/i.test(d.name))??null;c(f),h(f?URL.createObjectURL(f):null),p(v.filter(d=>/\.(mp3|wav|flac)$/i.test(d.name)))},P=u=>r(async({title:N,description:v})=>{const f=N?.trim()||w;if(!f||!n||o.length===0)return;const d=await Promise.all(o.map(async j=>({file:j,title:G(j),duration:await H(j)})));await J({title:f,groupName:i,description:v,cover:n,tracks:d}),u?.(),I(-1)});return{register:e,watch:l,errors:m,onFolderChange:T,folderSelected:k,folderName:w,coverPreview:t,trackCount:o.length,submitHandler:P,setValue:s}}const ge=()=>{const{onFolderChange:e,watch:r,errors:l,folderSelected:s,folderName:g,coverPreview:m,trackCount:i,submitHandler:n,register:c}=K(),{t}=O("addAlbumForm"),h=r("title");return a.jsxs("form",{onSubmit:o=>{o.preventDefault(),n()()},className:"flex flex-col gap-6 w-full max-w-md mx-auto",children:[m?a.jsx("img",{src:m,alt:t("coverPreviewAlt"),className:"w-32 h-32 object-cover rounded-md shadow-md mx-auto cursor-pointer",title:t("selectFolder"),onClick:()=>{const o=document.querySelector("input[type=file]");o&&"click"in o&&typeof o.click=="function"&&o.click()}}):a.jsx($,{directory:!0,onChange:e,placeholder:a.jsx(M,{size:48}),title:t("selectFolder"),active:s}),l.folder&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("folderRequired")}),s&&i>0&&!m&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("noCoverFound")}),s&&i===0&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("noTracksFound")}),a.jsx(S,{placeholder:t("albumTitle"),className:l.title?"border-red-600":"",...c("title")}),a.jsx(S,{placeholder:t("albumDescription"),className:"resize-none",...c("description")}),!h&&s&&a.jsxs("p",{className:"text-yellow-600 text-sm mt-1",children:[t("titleFromFolder")," ",a.jsx("b",{children:g})]}),a.jsx(R,{type:"submit",theme:B.OUTLINE,size:z.L,className:"self-center mt-2",children:t("addAlbum")})]})};export{ge as A};
