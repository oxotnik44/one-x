import{r as x,j as a}from"./iframe-U8ya4lKj.js";import{G as T}from"./iconBase--zlYJr49.js";import{u as R}from"./index.esm-BbXu7aDV.js";import{u as U}from"./GroupCover-BGBq_pSL.js";import{g as E}from"./getAudioDuration-BkZTS1fg.js";import"./useAlbumStore-2sgAmzBL.js";import{V as j,a as z,b as k}from"./api-BNB6Hzxt.js";import"./index-DSF9hKFK.js";import{B,a as D,b as $}from"./Button-DE9W436l.js";import{u as L}from"./ButtonNavigation-COrRjsTF.js";import"./Dropdown-DwKt7Qhu.js";import{F as q}from"./FilePicker-CbYA0TGi.js";import{I as A}from"./Input-DaFUx77P.js";import"./Like-B3pHqG2f.js";import"./Loader-DiHYOjMw.js";import"./index-C84dbosL.js";import"./PageLoader-DRYwdG-o.js";import"./PageWrapper-CGXxUwgW.js";import"./PlayButton-DHaq6iyc.js";import"./Text-DVKAWUAM.js";import"./TrackControlButton-9SyhFgiT.js";import"./UserAvatar-QfRyJ_rf.js";import{v as S}from"./v4-BKrj-4V8.js";import"./useTrackStore-OiNvfdpV.js";import"./TrackItem-BO_8qinM.js";import{u as H}from"./useTranslation-CSTQQmYg.js";function O(e){return e.name.replace(/\.[^/.]+$/,"")}const G=e=>decodeURIComponent(e).split("/").pop()?.replace(/\.[^/.]+$/,"")??"Untitled";async function V(e){if(!e.groupName)throw j.error("Группа не выбрана"),new Error("groupName is required");return await j.promise((async()=>{const r=new FormData;r.append("groupName",e.groupName),r.append("title",e.title),e.description&&r.append("description",e.description),r.append("cover",e.cover),e.tracks.forEach(({file:d})=>{r.append("tracks",d,d.name)});const p=z.post("/uploadAlbum",r,{headers:{"Content-Type":"multipart/form-data"}}),s=k.get(`/groups?name=${encodeURIComponent(e.groupName)}`),[g,u]=await Promise.all([p,s]),i=g.data,n=u.data[0]?.id;if(!n)throw new Error("Группа не найдена");const c=S(),t={id:c,name:e.title,groupId:n,cover:i.coverUrl,description:e.description??"",createdAt:new Date().toISOString(),trackIds:[]};await k.post("/albums",t);const h=i.tracksUrls.map(async(d,f)=>{const F={id:S(),title:e.tracks[f].title||G(d),duration:e.tracks[f].duration,cover:i.coverUrl,groupName:e.groupName,albumId:c,groupId:n,audioUrl:d,createdAt:new Date().toISOString()},{data:b}=await k.post("/tracks",F);return b.id}),o=await Promise.all(h);return await k.patch(`/albums/${c}`,{trackIds:o}),i})(),{loading:"Создание альбома...",success:"Альбом и треки успешно загружены",error:r=>r instanceof Error?r.message:"Ошибка при создании альбома"})}function M(e){return T({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M408 96H252.11a23.89 23.89 0 0 1-13.31-4L211 73.41A55.77 55.77 0 0 0 179.89 64H104a56.06 56.06 0 0 0-56 56v24h416c0-30.88-25.12-48-56-48zm15.75 352H88.25a56 56 0 0 1-55.93-55.15L16.18 228.11v-.28A48 48 0 0 1 64 176h384.1a48 48 0 0 1 47.8 51.83v.28l-16.22 164.74A56 56 0 0 1 423.75 448zm56.15-221.45z"},child:[]}]})(e)}function J(){const{register:e,handleSubmit:r,watch:p,setValue:s,clearErrors:g,formState:{errors:u}}=R(),i=U(l=>l.currentGroup?.name||""),[n,c]=x.useState(null),[t,h]=x.useState(null),[o,d]=x.useState([]),f=p("folder"),F=!!f?.length,b=x.useMemo(()=>f?.[0]?.webkitRelativePath?.split("/")[0]??"",[f]),y=L();x.useEffect(()=>{e("folder",{required:"folderRequired"}),e("title"),e("description")},[e]);const C=l=>{if(!l?.length)return;g(["folder","title"]),s("folder",l,{shouldValidate:!0});const v=Array.from(l),w=v.find(m=>/cover\.(jpe?g|png|gif|webp)$/i.test(m.name))??v.find(m=>/\.(jpe?g|png|gif|webp)$/i.test(m.name))??null;c(w),h(w?URL.createObjectURL(w):null),d(v.filter(m=>/\.(mp3|wav|flac)$/i.test(m.name)))},I=l=>r(async({title:v,description:w})=>{const m=v?.trim()||b;if(!m||!n||o.length===0)return;const P=await Promise.all(o.map(async N=>({file:N,title:O(N),duration:await E(N)})));await V({title:m,groupName:i,description:w,cover:n,tracks:P}),l?.(),y(-1)});return{register:e,watch:p,errors:u,onFolderChange:C,folderSelected:F,folderName:b,coverPreview:t,trackCount:o.length,submitHandler:I,setValue:s}}const xe=()=>{const{onFolderChange:e,watch:r,errors:p,folderSelected:s,folderName:g,coverPreview:u,trackCount:i,submitHandler:n,register:c}=J(),{t}=H("addAlbumForm"),h=r("title");return a.jsxs("form",{onSubmit:o=>{o.preventDefault(),n()()},className:"flex flex-col gap-6 w-full max-w-md mx-auto",children:[u?a.jsx("img",{src:u,alt:t("coverPreviewAlt"),className:"w-32 h-32 object-cover rounded-md shadow-md mx-auto cursor-pointer",title:t("selectFolder"),onClick:()=>{const o=document.querySelector("input[type=file]");o&&"click"in o&&typeof o.click=="function"&&o.click()}}):a.jsx(q,{directory:!0,onChange:e,placeholder:a.jsx(M,{size:48}),title:t("selectFolder"),active:s}),p.folder&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("folderRequired")}),s&&i>0&&!u&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("noCoverFound")}),s&&i===0&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("noTracksFound")}),a.jsx(A,{placeholder:t("albumTitle"),className:p.title?"border-red-600":"",...c("title")}),a.jsx(A,{placeholder:t("albumDescription"),className:"resize-none",...c("description")}),!h&&s&&a.jsxs("p",{className:"text-yellow-600 text-sm mt-1",children:[t("titleFromFolder")," ",a.jsx("b",{children:g})]}),a.jsx(B,{type:"submit",theme:$.OUTLINE,size:D.L,className:"self-center mt-2",children:t("addAlbum")})]})};export{xe as A};
