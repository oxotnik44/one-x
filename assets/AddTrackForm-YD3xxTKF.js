import{r as v,j as t}from"./iframe-C0kfoYRU.js";import{u as C,R as b,a as A}from"./ButtonNavigation-AGHQnJJF.js";import{G as R}from"./iconBase-BzJrSpo7.js";import{V as N,g as j,e as z,b as B,a as D}from"./AutoHideScroll-Bn4kiatZ.js";import{v as E}from"./v4-BKrj-4V8.js";import{B as I,a as V,b as y}from"./Button-BG29j6-m.js";import"./Dropdown-B0nLrr0u.js";import{F as T}from"./FilePicker-BOxeBJkN.js";import{I as U}from"./Input-Syt8WR94.js";import"./Like-CU83MUjH.js";import"./Loader-BA1QRYy5.js";import"./index-CCh5LiNu.js";import"./PageLoader-CjR7aYj7.js";import"./PageWrapper-CUwEEPPt.js";import{T as q}from"./Text-Cv_jbED3.js";import"./TrackControlButton-Cp9njBny.js";import"./UserAvatar-D3VV5S8d.js";import{u as H}from"./index.esm-CVV88-oh.js";import{g as L}from"./getAudioDuration-_SuZLsp4.js";import{u as G}from"./useTranslation-DTQxaVaH.js";async function M(e){return await N.promise((async()=>{if(!e.groupName)throw N.error("Группа не выбрана"),new Error("groupName is required");const{data:a}=await j.get("/groups",{params:{name:e.groupName}});if(!a.length)throw new Error(`Группа с именем "${e.groupName}" не найдена`);const m=a[0],r=new FormData;r.append("groupName",e.groupName),r.append("trackName",e.title),r.append("cover",e.cover),r.append("audio",e.audio);const s=await z.post("/uploadTrack",r,{headers:{"Content-Type":"multipart/form-data"}}),{coverUrl:l,audioUrl:n}=s.data,c={id:E(),title:e.title,duration:e.duration,cover:l,groupId:m.id,audioUrl:n,createdAt:new Date().toISOString()};await j.post("/tracks",c),B.getState().addTrack(c)})(),{loading:"Загрузка трека...",success:"Трек успешно добавлен",error:a=>a instanceof Error?a.message:"Ошибка при добавлении трека"})}function P(e){return R({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M256 64v225.1c-12.6-7.3-27.1-11.7-42.7-11.7-47.1 0-85.3 38.2-85.3 85.3s38.2 85.3 85.3 85.3 85.3-38.2 85.3-85.3V149.3H384V64H256z"},child:[]}]})(e)}function O(){const{register:e,handleSubmit:a,watch:m,setValue:r,formState:{errors:s}}=H(),l=D(o=>o.currentGroup?.name),[n,c]=v.useState(null),[d,i]=v.useState(null),[p,g]=v.useState(null),F=C();v.useEffect(()=>{e("cover",{required:!0}),e("audio",{required:!0}),e("title")},[e]);const f=(o,u)=>{if(!(!u||u.length===0))if(r(o,u,{shouldValidate:!0}),o==="cover")c(URL.createObjectURL(u[0]));else{const h=u[0];i(h.name),L(h).then(x=>{g(x)})}};return{register:e,watch:m,setValue:r,errors:s,coverPreview:n,audioSelected:!!d,audioFileName:d,onCoverChange:o=>f("cover",o),onAudioChange:o=>f("audio",o),submitHandler:o=>a(async({cover:u,audio:h,title:x})=>{const S=u[0],w=h[0],k=x?.trim()||w.name.replace(/\.[^/.]+$/,"");if(p==null){alert("Не удалось получить длительность аудио. Пожалуйста, подождите.");return}await M({title:k,cover:S,audio:w,duration:Math.round(p),groupName:l}),o?.(),F(-1)})}}const de=()=>{const{register:e,onCoverChange:a,onAudioChange:m,watch:r,errors:s,coverPreview:l,audioSelected:n,audioFileName:c,submitHandler:d}=O(),{t:i}=G("addTrackForm"),p=r("title");return t.jsxs("form",{onSubmit:g=>{g.preventDefault(),d()(g)},className:"flex flex-col gap-6 w-full max-w-md mx-auto",children:[t.jsxs("div",{className:"flex gap-4",children:[t.jsx(T,{accept:"image/*",onChange:a,previewUrl:l,placeholder:t.jsx(b,{size:48}),title:i("addCover")}),s.cover&&t.jsx("p",{className:"text-red-600 text-sm mt-1",children:i("coverRequired")}),t.jsx(T,{accept:"audio/mpeg",onChange:m,placeholder:n?t.jsx(P,{size:48}):t.jsx(A,{size:48}),title:i("addAudio"),active:n}),s.audio&&t.jsx("p",{className:"text-red-600 text-sm mt-1",children:i("audioRequired")})]}),t.jsx(U,{placeholder:i("trackTitle"),...e("title"),className:s.title?"border-red-600":""}),!p&&n&&t.jsxs(q,{className:"text-yellow-600 text-sm mt-1",size:"medium",children:[i("titleFromFile")," ",t.jsx("b",{children:c?.replace(/\.[^/.]+$/,"")})]}),t.jsx(I,{type:"submit",theme:y.OUTLINE,size:V.L,className:"self-center mt-2",children:i("addButton")})]})};export{de as A};
