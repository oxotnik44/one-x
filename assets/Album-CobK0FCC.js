import{r as i,R as P,j as s}from"./iframe-Bt4UvEqW.js";import{b as B,c as L}from"./Modal-B9i_GAWK.js";import{B as C,b as z}from"./Button-40eEdaHr.js";import{e as G}from"./ButtonNavigation-DuwpFPZD.js";import"./Dropdown-D_2yar06.js";import"./FilePicker-D62rdBOg.js";import{c as p,V as l,u as F,b as O,a as V}from"./index-BlSK3dwA.js";import{I as J}from"./Input-Bygz4nLz.js";import{L as q}from"./Like-DXxARhTn.js";import"./Loader-ld3rHLDK.js";import"./index-DfYkHRSD.js";import"./PageLoader-HUM1dPua.js";import"./PageWrapper-Nh9y5AVa.js";import{u as f,a as U,C as H,P as K}from"./ConfirmDeleteModal-BXHaXOST.js";import{T as A}from"./Text-IhfjRFJQ.js";import"./TrackControlButton-DKEqXBy9.js";import"./UserAvatar-B3tKy1se.js";import{L as Q}from"./ListTrack-CIxGZ3wT.js";import{l as W}from"./likeAlbum-DRyx3arP.js";import{g as X}from"./getAudioDuration-BkZTS1fg.js";import{v as Y}from"./v4-BKrj-4V8.js";import{u as $}from"./useTranslation-D6XLV_9q.js";async function Z(e,t){try{const{setCurrentAlbum:o}=f.getState(),{data:r}=await p.get("/albums",{params:{groupId:e,albumId:t}}),a=r.find(m=>m.id===t);a?o(a):l.error("Альбом не найден")}catch(o){l.error(o instanceof Error?o.message:"Ошибка при загрузке альбома")}}async function _(e){try{const{albums:t,setAlbums:o}=f.getState(),{currentGroup:r}=F.getState(),a=t.find(d=>d.id===e);if(!a||!r?.name){l.error("Ошибка: альбом или группа не найдены");return}await Promise.all([p.delete(`/albums/${e}`),O.delete(`/deleteAlbum/${encodeURIComponent(r.name)}/${encodeURIComponent(a.name)}`)]),o(t.filter(d=>d.id!==e));const{tracks:m,setTracks:c}=U.getState();c(m.filter(d=>d.albumId!==e)),l.success("Альбом и все его треки успешно удалены")}catch(t){l.error(t instanceof Error?t.message:"Ошибка при удалении альбома")}}async function ee(e,t){try{await p.patch(`/albums/${e}`,{description:t});const{albums:o,setAlbums:r}=f.getState();r(o.map(a=>a.id===e?{...a,description:t}:a)),l.success("Описание успешно обновлено")}catch(o){l.error(o instanceof Error?o.message:"Ошибка при обновлении описания")}}async function te(e,t,o){try{const r=new FormData;r.append("track",o);const a=await O.post(`/addTrack/${encodeURIComponent(e.name)}/${encodeURIComponent(t.name)}`,r,{headers:{"Content-Type":"multipart/form-data"}}),m=await X(o),c={id:Y(),title:o.name.replace(/\.[^/.]+$/,""),duration:m,cover:t.cover??"",groupName:e.name,albumId:t.id,groupId:e.id,audioUrl:a.data.trackUrl,createdAt:new Date().toISOString()};return await Promise.all([p.post("/tracks",c),p.patch(`/albums/${t.id}`,{trackIds:[...t.trackIds??[],c.id]})]),U.getState().addTrack(c),l.success("Трек успешно добавлен"),a.data}catch(r){throw l.error(r instanceof Error?r.message:"Ошибка при добавлении трека"),r}}function ae(){const{t:e}=$("album"),{albumId:t}=G(),o=V(n=>n.authData?.likedAlbums??[]),r=F(n=>n.currentGroup),a=f(n=>n.currentAlbum),m=f(n=>n.setCurrentAlbum),[c,d]=i.useState(a?.description??""),[u,x]=i.useState(!1),[g,h]=i.useState(!1),[b,k]=i.useState(!1),y=i.useRef(null);i.useEffect(()=>{!a&&t&&r&&Z(r.id,t).catch(()=>l.error(e("loadAlbumError")))},[t,a,r]),i.useEffect(()=>{d(a?.description??"")},[a]);const j=i.useCallback(n=>{d(n)},[]),N=i.useCallback(()=>{if(!a?.id){l.error(e("albumNotSelected"));return}W(a.id)},[a?.id,e]),v=i.useCallback(async()=>{if(!(u||!a)){x(!0);try{await ee(a.id,c),k(!1)}catch{l.error(e("saveError"))}finally{x(!1)}}},[u,a,c,e]),w=i.useCallback(async()=>{if(!a){l.error(e("albumNotSelected"));return}try{await _(a.id),m(null),l.success(e("albumDeleted"))}catch{l.error(e("deleteError"))}finally{h(!1)}},[a,m,e]),D=i.useCallback(()=>{y.current?.click()},[]),S=i.useCallback(async n=>{const T=n.target.files;if(T?.length){if(!r||!a){l.error(e("albumOrGroupNotSelected")),n.target.value="";return}try{await te(r,a,T[0])}catch(M){l.error(e("uploadTrackError")),console.error(M)}finally{n.target.value=""}}},[r,a,e]),I=i.useCallback(n=>{h(n)},[]),E=i.useCallback(n=>{k(n)},[]);return i.useMemo(()=>({currentAlbum:a,desc:c,setDesc:j,saving:u,isDeleteModalOpen:g,setIsDeleteModalOpen:I,isEditing:b,setIsEditing:E,onSave:v,onDelete:w,fileInputRef:y,toggleAlbum:N,openFileDialog:D,onFileChange:S,likedAlbums:o}),[a,c,j,u,g,I,b,E,v,w,D,S,o])}const R=e=>{const t=new Date(e);return isNaN(t.getTime())?"Invalid Date":new Intl.DateTimeFormat("ru-RU",{day:"numeric",month:"long",year:"numeric"}).format(t).replace(/ г\.$/," г.")},se=()=>{const{t:e}=$("album"),{currentAlbum:t,desc:o,setDesc:r,saving:a,isDeleteModalOpen:m,setIsDeleteModalOpen:c,isEditing:d,setIsEditing:u,onSave:x,onDelete:g,fileInputRef:h,toggleAlbum:b,openFileDialog:k,onFileChange:y,likedAlbums:j}=ae();if(!t)return s.jsx("div",{className:"p-4 text-center text-gray-500",children:e("notSelected")});const N=j.includes(t.id);return s.jsxs("div",{className:"relative flex flex-col gap-1 py-6 px-20 text-white min-h-[400px]",children:[s.jsx(C,{className:"absolute top-4 right-4 p-2 text-gray-400 hover:text-red-500 transition-colors",onClick:()=>c(!0),"aria-label":e("deleteAlbum"),children:s.jsx(B,{size:22})}),s.jsx(H,{isOpen:m,onClose:()=>c(!1),onConfirm:g}),s.jsxs("div",{className:"flex justify-between items-start gap-6 px-4 py-3 h-64",children:[s.jsxs("div",{className:"flex items-start gap-4 flex-shrink-0 max-w-xl",children:[s.jsx("img",{src:t.cover,alt:t.name,className:"w-64 h-64 object-cover rounded-md shadow-lg"}),s.jsxs("div",{className:"flex flex-col justify-center mt-15 max-w-[450px]",children:[s.jsx(A,{className:"text-4xl font-bold",children:t.name}),t.createdAt&&s.jsx(A,{className:"mt-4 text-gray-400 text-sm",children:e("created",{date:R(t.createdAt)})}),t.updatedAt&&s.jsx(A,{className:"text-gray-400 text-sm",children:e("updated",{date:R(t.updatedAt)})}),s.jsx("div",{className:"mt-4 flex items-start gap-2",children:d?s.jsxs(s.Fragment,{children:[s.jsx(J,{className:"flex-1 rounded-md p-2 text-black resize-y",value:o,onChange:v=>r(v.target.value),disabled:a}),s.jsx(C,{onClick:x,disabled:a,children:e(a?"saving":"save")})]}):s.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[s.jsx(A,{className:"text-gray-300 whitespace-pre-wrap break-words",children:o||e("noDescription")}),s.jsx(C,{onClick:()=>u(!0),"aria-label":e("editDescription"),className:"text-gray-400 hover:text-white p-1 transition-colors",children:s.jsx(L,{size:20})})]})}),s.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[s.jsx(K,{theme:z.OUTLINE,albumForPlay:t,trackForPlay:null}),s.jsx(q,{liked:N,onToggle:b})]})]})]}),s.jsxs("div",{className:"flex flex-col justify-end h-60",children:[s.jsx(C,{type:"button",onClick:k,children:e("uploadTrack")}),s.jsx("input",{type:"file",accept:"audio/*",ref:h,className:"hidden",onChange:y})]})]}),s.jsx("div",{className:"flex justify-center overflow-auto flex-grow mt-10 h-full",children:s.jsx(Q,{albumId:t.id,albumName:t.name})})]})},we=P.memo(se);export{we as A};
