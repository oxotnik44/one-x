import{c as L,r as x,u as B,j as i,R as G}from"./iframe-Bt4UvEqW.js";import{M as V}from"./Modal-B9i_GAWK.js";import{b as H,B as $,a as q}from"./Button-40eEdaHr.js";import"./ButtonNavigation-DuwpFPZD.js";import{D as J}from"./Dropdown-D_2yar06.js";import"./FilePicker-D62rdBOg.js";import{c as b,b as j,a as O,V as h,u as E}from"./index-BlSK3dwA.js";import"./Input-Bygz4nLz.js";import{L as W}from"./Like-DXxARhTn.js";import"./Loader-ld3rHLDK.js";import"./PageLoader-HUM1dPua.js";import"./PageWrapper-Nh9y5AVa.js";import{b as U,c as N}from"./index-i_s2-YOI.js";import"./index-DfYkHRSD.js";import{T as w}from"./Text-IhfjRFJQ.js";import"./TrackControlButton-DKEqXBy9.js";import"./UserAvatar-B3tKy1se.js";import{G as K}from"./iconBase-ou9WzbwP.js";import{u as R}from"./useTranslation-D6XLV_9q.js";const C=L(e=>({tracks:[],currentTrack:null,isPlaying:!1,loading:!1,setLoading:r=>e({loading:r}),setTracks:r=>e({tracks:r}),addTrack:r=>e(s=>({tracks:[...s.tracks,r]})),updateTrack:r=>e(s=>({tracks:s.tracks.map(t=>t.id===r.id?r:t)})),removeTrack:r=>e(s=>({tracks:s.tracks.filter(t=>t.id!==r)})),setCurrentTrack:r=>e({currentTrack:r}),setIsPlaying:r=>e({isPlaying:r}),togglePlay:()=>e(r=>({isPlaying:!r.isPlaying}))}));async function Q(e,r,s,t){try{const[n,m]=await Promise.all([b.get("/tracks",{params:{groupId:e,albumId:s&&t?s:void 0}}),s&&t?j.get(`/album-tracks/${encodeURIComponent(r)}/${encodeURIComponent(t)}`):j.get(`/tracks/${encodeURIComponent(r)}`)]),l=n.data;if(!Array.isArray(l))return C.getState().setTracks([]),[];let o=[];if(s&&t){const c=m.data,f=c.coverUrl??"";o=c.tracks.map(p=>({trackName:p.trackName,audioUrl:p.audioUrl,coverUrl:f}))}else o=m.data;const d=l.map(c=>{const f=o.find(p=>p.trackName===c.id||p.trackName===c.title);return{...c,cover:f?.coverUrl??"",audioUrl:f?.audioUrl??"",groupName:r}}).filter(c=>s&&t?c.albumId===s:!c.albumId||c.albumId==="");return C.getState().setTracks(d),d}catch(n){return console.error("Ошибка при загрузке треков с медиа",n),C.getState().setTracks([]),[]}}const X=async e=>{const{authData:r,toggleLikeTrack:s}=O.getState();if(!r){h.error("Войдите, чтобы лайкать");return}const t=r.likedTracks??[],n=t.includes(e)?t.filter(m=>m!==e):[...t,e];try{await b.patch(`/users/${r.id}`,{likedTracks:n}),s(e),h.success(t.includes(e)?"💔 Убрано из избранного":"❤️ Добавлено в избранное")}catch{h.error("Не удалось обновить лайк")}};function Y(e){return K({attr:{fill:"none",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"},child:[]}]})(e)}const Z=e=>{const r=Math.floor(e/60),s=Math.floor(e%60);return`${r}:${s.toString().padStart(2,"0")}`},A=L(e=>({albums:[],currentAlbum:null,setAlbums:r=>e({albums:r}),addAlbum:r=>e(s=>({albums:[...s.albums,r]})),updateAlbum:(r,s)=>e(t=>({albums:t.albums.map(n=>n.id===r?{...n,...s}:n)})),removeAlbum:r=>e(s=>({albums:s.albums.filter(t=>t.id!==r)})),appendTrackToAlbum:(r,s)=>e(t=>({albums:t.albums.map(n=>n.id===r?{...n,trackIds:[...n.trackIds,s]}:n)})),setCurrentAlbum:r=>e({currentAlbum:r}),clearCurrentAlbum:()=>e({currentAlbum:null})}));async function _(e,r,s,t){if(!s||!t){h.error("Ошибка: группа или альбом не выбраны");return}const n=s.name,m=t.name,l=t.trackIds.filter(o=>o!==e);try{await Promise.all([j.delete(`/deleteTrack/${encodeURIComponent(n)}/${encodeURIComponent(m)}/${encodeURIComponent(r)}`),b.delete(`/tracks/${e}`),b.patch(`/albums/${t.id}`,{trackIds:l})]);const{tracks:o,setTracks:d}=C.getState();d(o.filter(k=>k.id!==e));const{albums:c,setAlbums:f}=A.getState(),p=c.map(k=>k.id===t.id?{...k,trackIds:l}:k);f(p),h.success(`Трек "${r}" успешно удалён из альбома "${m}"`)}catch(o){h.error(o instanceof Error?o.message:"Ошибка при удалении трека")}}const F=async(e,r,s)=>{try{await Promise.all([j.delete(`/deleteTrack/${encodeURIComponent(e)}/${encodeURIComponent(r)}`),b.delete(`/tracks/${s}`)]),C.getState().removeTrack(s),h.success(`Трек "${r}" успешно удалён!`)}catch(t){console.error(t),h.error(t instanceof Error?t.message:"Ошибка при удалении трека")}},y=L((e,r)=>({currentTrack:null,progress:0,currentTime:0,isPlaying:!1,duration:0,volume:1,isMuted:!1,audio:null,setCurrentTrack:s=>{const t=r();t.audio&&(t.audio.pause(),t.audio.src="");const n=new Audio(s.audioUrl);n.volume=t.isMuted?0:t.volume,n.addEventListener("ended",()=>{const m=r(),l=C.getState().tracks??[],o=l.findIndex(d=>d.id===m.currentTrack?.id);if(o!==-1&&o<l.length-1){const d=l[o+1];m.setCurrentTrack(d)}else n.pause(),e({isPlaying:!1})}),n.addEventListener("loadedmetadata",()=>{e({duration:n.duration})}),n.addEventListener("timeupdate",()=>{e({progress:n.currentTime/n.duration*100,currentTime:n.currentTime})}),n.play().catch(()=>{console.warn("Автовоспроизведение запрещено браузером")}),e({currentTrack:s,audio:n,isPlaying:!0})},setProgress:s=>{const t=r().audio;t&&(t.currentTime=s/100*t.duration),e({progress:s})},setIsPlaying:s=>{const t=r().audio;t&&(s?t.play().catch(n=>console.warn("Ошибка воспроизведения аудио:",n)):t.pause(),e({isPlaying:s}))},setDuration:s=>e({duration:s}),setVolume:s=>{const t=r().audio;t&&(t.volume=s),e({volume:s})},setIsMuted:s=>{const t=r().audio;t&&(t.volume=s?0:r().volume),e({isMuted:s})},togglePlay:()=>{const{isPlaying:s,setIsPlaying:t}=r();t(!s)}}));function ee({track:e,groupName:r,onConfirmDelete:s}){const[t,n]=x.useState(!1),[m,l]=x.useState(!1),o=x.useRef(null),d=E(a=>a.currentGroup),c=A(a=>a.currentAlbum),f=O(a=>a.authData),p=B(a=>a.theme),k=y(a=>a.currentTrack),T=y(a=>a.togglePlay),g=y(a=>a.setCurrentTrack),I=!!f?.likedTracks?.includes(e.id),D=x.useCallback(()=>{X(e.id)},[e.id]),v=x.useCallback(()=>{k?.id!==e.id?g(e):T()},[k,e,g,T]),P=x.useCallback(()=>n(a=>!a),[]);x.useEffect(()=>{const a=z=>{o.current&&!o.current.contains(z.target)&&n(!1)};return t&&document.addEventListener("mousedown",a),()=>{document.removeEventListener("mousedown",a)}},[t]);const S=()=>{n(!1),l(!1),setTimeout(()=>l(!0),0)},u=x.useCallback(async()=>{l(!1);try{if(!e.albumId)await F(r,e.title,e.id);else{if(!d||!c)return;await _(e.id,e.title,d,c)}s?.(e)}catch(a){console.error(a)}},[e,r,d,c,s]);return{isDropdownOpen:t,isConfirmOpen:m,modalRef:o,theme:p,liked:I,toggleLike:D,onPlayClick:v,toggleDropdown:P,onDeleteClick:S,onConfirmDeleteClick:u,setConfirmOpen:l,setDropdownOpen:n}}const te=({track:e,groupName:r,onConfirmDelete:s})=>{const{isDropdownOpen:t,isConfirmOpen:n,modalRef:m,theme:l,liked:o,toggleLike:d,toggleDropdown:c,onDeleteClick:f,setDropdownOpen:p,onConfirmDeleteClick:k,setConfirmOpen:T}=ee({track:e,groupName:r,onConfirmDelete:s}),{t:g}=R("trackItem");return i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"flex w-full max-w-full items-center border rounded overflow-hidden",style:{backgroundColor:"var(--bg-container)"},children:[i.jsxs("div",{className:"relative w-20 h-20 flex-shrink-0",children:[i.jsx("img",{loading:"lazy",width:80,height:80,src:e.cover,alt:e.title,className:"object-cover rounded-tr-lg rounded-br-lg"}),i.jsx("div",{className:"absolute inset-0 bg-black/0 hover:bg-black/50 transition-colors flex items-center justify-center rounded-tr-lg rounded-br-lg",children:i.jsx(M,{theme:H.CLEAR,showOnHover:!0,trackForPlay:e})})]}),i.jsxs("div",{className:"flex flex-col justify-center flex-grow px-4 overflow-hidden",children:[i.jsx(w,{size:"medium",className:"truncate",children:r}),i.jsx(w,{size:"medium",className:"truncate font-semibold",children:e.title})]}),i.jsxs("div",{className:"flex gap-5 items-center px-4 min-w-[60px] relative",children:[i.jsx(W,{liked:o,onToggle:d}),i.jsx(w,{size:"small",children:Z(e.duration)}),i.jsx("button",{className:"p-1 rounded-full border border-white hover:border-gray-300 hover:text-black text-gray-500 transition-colors cursor-pointer",onClick:c,children:i.jsx(Y,{size:20,color:l["--primary-color"]})}),i.jsxs(J,{isOpen:t,onClose:()=>p(!1),className:"ml-30 mb-35 min-w-[120px]",ref:m,children:[i.jsx("div",{className:"text-sm cursor-pointer hover:bg-gray-100 rounded p-2",onClick:f,children:g("delete")}),i.jsx("div",{className:"text-sm cursor-pointer hover:bg-gray-100 rounded p-2",children:g("option2")})]})]})]}),i.jsx(re,{isOpen:n,onClose:()=>T(!1),onConfirm:k})]})};te.displayName="TrackItem";const M=G.memo(({albumForPlay:e,className:r="",theme:s,showOnHover:t=!1,trackForPlay:n})=>{const{t:m}=R("playButton"),l=C(u=>u.tracks),o=y(u=>u.togglePlay),d=y(u=>u.setCurrentTrack),c=y(u=>u.currentTrack),f=y(u=>u.isPlaying),k=A(u=>u.currentAlbum)?.id===e?.id,T=c?.id===n?.id,g=E(u=>u.currentGroup),I=A(u=>u.setCurrentAlbum),D=async()=>{if(e){if(!k){if(I(e),g)try{await Q(g.id,g.name,e.id,e.name);const a=C.getState().tracks?.[0];a&&d(a),o()}catch(a){h.error(a instanceof Error?a.message:"Ошибка при загрузке альбома");return}o();return}if(!e.trackIds.includes(c?.id??"")){const a=l?.[0];a&&(d(a),o())}o()}n&&(T||(d(n),o()),o())},v=e?e.trackIds.includes(c?.id??""):!1,P=e?f&&v?U:N:f&&T?U:N,S=m(f&&(e?v:T)?"pause":"play");return i.jsx($,{size:q.L,square:!0,onClick:D,theme:s,className:`${t?"opacity-0 hover:opacity-100":"opacity-100"} transition-opacity ${r}`,"aria-label":S,children:i.jsx(P,{className:"h-6 w-6 text-white"})})});M.displayName="PlayButton";const re=({isOpen:e,onClose:r,onConfirm:s})=>{const{t}=R("confirmDeleteModal");return i.jsx(V,{isOpen:e,onClose:r,closable:!0,children:i.jsxs("div",{className:"flex flex-col gap-4 min-w-[300px]",children:[i.jsx(w,{className:"text-lg font-semibold text-white",children:t("confirmDelete")}),i.jsxs("div",{className:"flex justify-center gap-10",children:[i.jsx($,{onClick:r,children:t("cancel")}),i.jsx($,{onClick:s,children:t("delete")})]})]})})};export{re as C,M as P,te as T,C as a,y as b,Q as c,Z as f,X as l,A as u};
