import{r as x,j as o}from"./iframe-C0kfoYRU.js";import{G as R}from"./iconBase-BzJrSpo7.js";import{u as z}from"./index.esm-CVV88-oh.js";import{V as S,e as B,g as b,a as y}from"./AutoHideScroll-Bn4kiatZ.js";import{B as D,a as $,b as L}from"./Button-BG29j6-m.js";import{u as q}from"./ButtonNavigation-AGHQnJJF.js";import"./Dropdown-B0nLrr0u.js";import{F as G}from"./FilePicker-BOxeBJkN.js";import{I as C}from"./Input-Syt8WR94.js";import"./Like-CU83MUjH.js";import"./Loader-BA1QRYy5.js";import"./index-CCh5LiNu.js";import"./PageLoader-CjR7aYj7.js";import"./PageWrapper-CUwEEPPt.js";import"./Text-Cv_jbED3.js";import"./TrackControlButton-Cp9njBny.js";import"./UserAvatar-D3VV5S8d.js";import{v as I}from"./v4-BKrj-4V8.js";import{g as H}from"./getAudioDuration-_SuZLsp4.js";import{u as O}from"./useTranslation-DTQxaVaH.js";const V=e=>e.name.replace(/\.[^/.]+$/,""),J=e=>decodeURIComponent(e).split("/").pop()?.replace(/\.[^/.]+$/,"")??"Untitled";async function M(e){if(!e.groupName)throw S.error("Группа не выбрана"),new Error("groupName is required");return await S.promise((async()=>{const r=new FormData;r.append("groupName",e.groupName),r.append("title",e.title),e.description&&r.append("description",e.description),r.append("cover",e.cover),e.tracks.forEach(({file:c})=>{r.append("tracks",c,c.name)});const m=B.post("/uploadAlbum",r,{headers:{"Content-Type":"multipart/form-data"}}),s=b.get(`/groups?name=${encodeURIComponent(e.groupName)}`),[g,p]=await Promise.all([m,s]),n=g.data,u=p.data[0]?.id;if(!u)throw new Error("Группа не найдена");const i=I(),t={id:i,name:e.title,groupId:u,cover:n.coverUrl,description:e.description??"",createdAt:new Date().toISOString(),trackIds:[]};await b.post("/albums",t);const h=n.tracksUrls.map(async(c,w)=>{const j={id:I(),title:e.tracks[w].title||J(c),duration:e.tracks[w].duration,cover:n.coverUrl,groupName:e.groupName,albumId:i,groupId:u,genre:e.genre,audioUrl:c,createdAt:new Date().toISOString()},{data:F}=await b.post("/tracks",j);return F.id}),a=await Promise.all(h);return await b.patch(`/albums/${i}`,{trackIds:a}),n})(),{loading:"Создание альбома...",success:"Альбом и треки успешно загружены",error:r=>r instanceof Error?r.message:"Ошибка при создании альбома"})}function K(e){return R({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M408 96H252.11a23.89 23.89 0 0 1-13.31-4L211 73.41A55.77 55.77 0 0 0 179.89 64H104a56.06 56.06 0 0 0-56 56v24h416c0-30.88-25.12-48-56-48zm15.75 352H88.25a56 56 0 0 1-55.93-55.15L16.18 228.11v-.28A48 48 0 0 1 64 176h384.1a48 48 0 0 1 47.8 51.83v.28l-16.22 164.74A56 56 0 0 1 423.75 448zm56.15-221.45z"},child:[]}]})(e)}function Q(){const{register:e,handleSubmit:r,watch:m,setValue:s,clearErrors:g,formState:{errors:p}}=z(),n=y(l=>l.currentGroup?.name||""),u=y(l=>l.currentGroup?.genre||""),[i,t]=x.useState(null),[h,a]=x.useState(null),[c,w]=x.useState([]),F=!!m("folder")?.length,[A,T]=x.useState(""),P=q();x.useEffect(()=>{e("folder",{required:"folderRequired"}),e("title"),e("description")},[e]);const U=(l,k)=>{if(!l?.length)return;g(["folder","title"]),s("folder",l,{shouldValidate:!0}),T(k??"");const v=Array.from(l),f=v.find(d=>/cover\.(jpe?g|png|gif|webp)$/i.test(d.name))??v.find(d=>/\.(jpe?g|png|gif|webp)$/i.test(d.name))??null;t(f),a(f?URL.createObjectURL(f):null),w(v.filter(d=>/\.(mp3|wav|flac)$/i.test(d.name)))},E=l=>r(async({title:k,description:v})=>{const f=k?.trim()||A;if(!f||!i||c.length===0)return;const d=await Promise.all(c.map(async N=>({file:N,title:V(N),duration:await H(N)})));await M({title:f,groupName:n,description:v,cover:i,tracks:d,genre:u}),l?.(),P(-1)});return{register:e,watch:m,errors:p,onFolderChange:U,folderSelected:F,folderName:A,coverPreview:h,trackCount:c.length,submitHandler:E,setValue:s}}const ge=()=>{const{onFolderChange:e,watch:r,errors:m,folderSelected:s,folderName:g,coverPreview:p,trackCount:n,submitHandler:u,register:i}=Q(),{t}=O("addAlbumForm"),h=r("title");return o.jsxs("form",{onSubmit:a=>{a.preventDefault(),u()()},className:"flex flex-col gap-6 w-full max-w-md mx-auto",children:[p?o.jsx("img",{src:p,alt:t("coverPreviewAlt"),className:"w-32 h-32 object-cover rounded-md shadow-md mx-auto cursor-pointer",title:t("selectFolder"),onClick:()=>{const a=document.querySelector("input[type=file]");a&&"click"in a&&typeof a.click=="function"&&a.click()}}):o.jsx(G,{directory:!0,onChange:e,placeholder:o.jsx(K,{size:48}),title:t("selectFolder"),active:s}),m.folder&&o.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("folderRequired")}),s&&n>0&&!p&&o.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("noCoverFound")}),s&&n===0&&o.jsx("p",{className:"text-red-600 text-sm mt-1",children:t("noTracksFound")}),o.jsx(C,{placeholder:t("albumTitle"),className:m.title?"border-red-600":"",...i("title")}),o.jsx(C,{placeholder:t("albumDescription"),className:"resize-none",...i("description")}),!h&&s&&o.jsxs("p",{className:"text-yellow-600 text-sm mt-1",children:[t("titleFromFolder")," ",o.jsx("b",{children:g})]}),o.jsx(D,{type:"submit",theme:L.OUTLINE,size:$.L,className:"self-center mt-2",children:t("addAlbum")})]})};export{ge as A};
