import{r as n,R as z,j as r}from"./iframe-U8ya4lKj.js";import{c as G,d as L}from"./index-B2TlSA0P.js";import{B as j}from"./Button-DE9W436l.js";import{c as P}from"./ButtonNavigation-COrRjsTF.js";import"./Dropdown-DwKt7Qhu.js";import"./FilePicker-CbYA0TGi.js";import{u as F}from"./GroupCover-BGBq_pSL.js";import{I as V}from"./Input-DaFUx77P.js";import"./Like-B3pHqG2f.js";import"./Loader-DiHYOjMw.js";import"./index-C84dbosL.js";import"./PageLoader-DRYwdG-o.js";import"./PageWrapper-CGXxUwgW.js";import"./PlayButton-DHaq6iyc.js";import{T as k}from"./Text-DVKAWUAM.js";import"./TrackControlButton-9SyhFgiT.js";import"./UserAvatar-QfRyJ_rf.js";import{C as J}from"./TrackItem-BO_8qinM.js";import{b as u,V as l,a as $}from"./api-BNB6Hzxt.js";import{u as O}from"./useTrackStore-OiNvfdpV.js";import{L as q}from"./ListTrack--FkH-x-r.js";import{u as p}from"./useAlbumStore-2sgAmzBL.js";import"./index-DSF9hKFK.js";import{g as H}from"./getAudioDuration-BkZTS1fg.js";import{v as K}from"./v4-BKrj-4V8.js";import{u as M}from"./useTranslation-CSTQQmYg.js";async function Q(e,t){try{const{setCurrentAlbum:s}=p.getState(),{data:a}=await u.get("/albums",{params:{groupId:e,albumId:t}});s(Array.isArray(a)?a[0]:a)}catch(s){l.error(s instanceof Error?s.message:"Ошибка при загрузке альбома")}}async function W(e){try{const{albums:t,setAlbums:s}=p.getState(),{currentGroup:a}=F.getState(),o=t.find(i=>i.id===e);if(!o||!a?.name){l.error("Ошибка: альбом или группа не найдены");return}await Promise.all([u.delete(`/albums/${e}`),$.delete(`/deleteAlbum/${encodeURIComponent(a.name)}/${encodeURIComponent(o.name)}`)]),s(t.filter(i=>i.id!==e));const{tracks:d,setTracks:m}=O.getState();m(d.filter(i=>i.albumId!==e)),l.success("Альбом и все его треки успешно удалены")}catch(t){l.error(t instanceof Error?t.message:"Ошибка при удалении альбома")}}async function X(e,t){try{await u.patch(`/albums/${e}`,{description:t});const{albums:s,setAlbums:a}=p.getState();a(s.map(o=>o.id===e?{...o,description:t}:o)),l.success("Описание успешно обновлено")}catch(s){l.error(s instanceof Error?s.message:"Ошибка при обновлении описания")}}async function Y(e,t,s){try{const a=new FormData;a.append("track",s);const o=await $.post(`/addTrack/${encodeURIComponent(e.name)}/${encodeURIComponent(t.name)}`,a,{headers:{"Content-Type":"multipart/form-data"}}),d=await H(s),m={id:K(),title:s.name.replace(/\.[^/.]+$/,""),duration:d,cover:t.cover??"",groupName:e.name,albumId:t.id,groupId:e.id,audioUrl:o.data.trackUrl,createdAt:new Date().toISOString()};return await Promise.all([u.post("/tracks",m),u.patch(`/albums/${t.id}`,{trackIds:[...t.trackIds??[],m.id]})]),O.getState().addTrack(m),l.success("Трек успешно добавлен"),o.data}catch(a){throw l.error(a instanceof Error?a.message:"Ошибка при добавлении трека"),a}}function Z(){const{t:e}=M("album"),{albumId:t}=P(),s=F(c=>c.currentGroup),a=p(c=>c.currentAlbum),o=p(c=>c.setCurrentAlbum),[d,m]=n.useState(a?.description??""),[i,f]=n.useState(!1),[x,g]=n.useState(!1),[h,b]=n.useState(!1),[y,v]=n.useState(!1),w=n.useRef(null);n.useEffect(()=>{!a&&t&&s&&Q(s.id,t).catch(()=>l.error(e("loadAlbumError")))},[t,a,s,e]),n.useEffect(()=>{m(a?.description??"")},[a]);const N=n.useCallback(c=>{m(c)},[]),S=n.useCallback(async()=>{if(!i){if(!a){l.error(e("albumNotSelected"));return}f(!0);try{await X(a.id,d),b(!1)}catch{l.error(e("saveError"))}finally{f(!1)}}},[i,a,d,e]),D=n.useCallback(async()=>{if(!a){l.error(e("albumNotSelected"));return}try{await W(a.id),o(null),l.success(e("albumDeleted"))}catch{l.error(e("deleteError"))}finally{g(!1)}},[a,o,e]),A=n.useCallback(()=>{w.current?.click()},[]),I=n.useCallback(async c=>{const C=c.target.files;if(C&&C.length>0){const U=C[0];if(!s||!a){l.error(e("albumOrGroupNotSelected")),c.target.value="";return}v(!0);try{await Y(s,a,U)}catch(B){l.error(e("uploadTrackError")),console.error(B)}finally{v(!1),c.target.value=""}}},[s,a,e]),E=n.useCallback(c=>{g(c)},[]),T=n.useCallback(c=>{b(c)},[]);return n.useMemo(()=>({currentAlbum:a,desc:d,setDesc:N,saving:i,isDeleteModalOpen:x,setIsDeleteModalOpen:E,isEditing:h,setIsEditing:T,onSave:S,onDelete:D,fileInputRef:w,openFileDialog:A,onFileChange:I,loadingTrack:y}),[a,d,N,i,x,E,h,T,S,D,A,I,y])}const R=e=>{const t=new Date(e);return isNaN(t.getTime())?"Invalid Date":new Intl.DateTimeFormat("ru-RU",{day:"numeric",month:"long",year:"numeric"}).format(t).replace(/ г\.$/," г.")},_=()=>{const{t:e}=M("album"),{currentAlbum:t,desc:s,setDesc:a,saving:o,isDeleteModalOpen:d,setIsDeleteModalOpen:m,isEditing:i,setIsEditing:f,onSave:x,onDelete:g,fileInputRef:h,openFileDialog:b,onFileChange:y}=Z();return t?r.jsxs("div",{className:"relative flex flex-col gap-1 py-6 px-20 text-white min-h-[400px]",children:[r.jsx(j,{className:"absolute top-4 right-4 p-2 text-gray-400 hover:text-red-500 transition-colors",onClick:()=>m(!0),"aria-label":e("deleteAlbum"),children:r.jsx(G,{size:22,style:{color:"var(--primary-color)"}})}),r.jsx(J,{isOpen:d,onClose:()=>m(!1),onConfirm:g}),r.jsxs("div",{className:"flex justify-between items-start gap-6 px-4 py-3 h-64",children:[r.jsxs("div",{className:"flex items-start gap-4 flex-shrink-0 max-w-xl",children:[r.jsx("img",{src:t.cover,alt:t.name,className:"w-64 h-64 object-cover rounded-md shadow-lg"}),r.jsxs("div",{className:"flex flex-col justify-center mt-15 max-w-[450px]",children:[r.jsx(k,{className:"text-4xl font-bold",children:t.name}),t.createdAt&&r.jsx(k,{className:"mt-4 text-gray-400 text-sm",children:e("created",{date:R(t.createdAt)})}),t.updatedAt&&r.jsx(k,{className:"text-gray-400 text-sm",children:e("updated",{date:R(t.updatedAt)})}),r.jsx("div",{className:"mt-4 flex items-start gap-2",children:i?r.jsxs(r.Fragment,{children:[r.jsx(V,{className:"flex-1 rounded-md p-2 text-black resize-y",value:s,onChange:v=>a(v.target.value),disabled:o}),r.jsx(j,{onClick:x,className:"self-start",disabled:o,children:e(o?"saving":"save")})]}):r.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[r.jsx(k,{className:"text-gray-300 whitespace-pre-wrap break-words",children:s||e("noDescription")}),r.jsx(j,{onClick:()=>f(!0),"aria-label":e("editDescription"),className:"text-gray-400 hover:text-white p-1 transition-colors",children:r.jsx(L,{size:20})})]})})]})]}),r.jsxs("div",{className:"flex flex-col justify-end h-60",children:[r.jsx(j,{type:"button",onClick:b,children:e("uploadTrack")}),r.jsx("input",{type:"file",accept:"audio/*",ref:h,className:"hidden",onChange:y})]})]}),r.jsx("div",{className:"flex justify-center overflow-auto flex-grow mt-10 h-full",children:r.jsx(q,{albumId:t.id,albumName:t.name})})]}):r.jsx("div",{className:"p-4 text-center text-gray-500",children:e("notSelected")})},Se=z.memo(_);export{Se as A};
