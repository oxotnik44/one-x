import{r as i,R as B,j as t}from"./iframe-C0kfoYRU.js";import{b as L,c as G}from"./Modal-ot01iIn6.js";import{B as C,b as z}from"./Button-BG29j6-m.js";import{u as V,d as J}from"./ButtonNavigation-AGHQnJJF.js";import"./Dropdown-B0nLrr0u.js";import"./FilePicker-BOxeBJkN.js";import{u as b,g,V as c,b as $,a as O,e as U,c as _,C as q,P as H}from"./AutoHideScroll-Bn4kiatZ.js";import{I as K}from"./Input-Syt8WR94.js";import{L as Q}from"./Like-CU83MUjH.js";import"./Loader-BA1QRYy5.js";import"./index-CCh5LiNu.js";import"./PageLoader-CjR7aYj7.js";import"./PageWrapper-CUwEEPPt.js";import{T as N}from"./Text-Cv_jbED3.js";import"./TrackControlButton-Cp9njBny.js";import"./UserAvatar-D3VV5S8d.js";import{L as W}from"./ListTrack-C5Wm6c44.js";import{l as X}from"./likeAlbum-gMHzl6hR.js";import{g as Y}from"./getAudioDuration-_SuZLsp4.js";import{v as Z}from"./v4-BKrj-4V8.js";import{u as M}from"./useTranslation-DTQxaVaH.js";async function ee(s,e){try{const{setCurrentAlbum:r}=b.getState(),{data:l}=await g.get("/albums",{params:{groupId:s,albumId:e}}),o=l.find(a=>a.id===e);o&&r(o)}catch(r){c.error(r instanceof Error?r.message:"Ошибка при загрузке альбома")}}async function te(s){try{const e=s.id,r=s.name,l=b.getState(),o=$.getState(),a=O.getState();if(!a.currentGroup?.name){c.error("Ошибка: группа не найдена");return}const{tracks:d,setTracks:u}=o,{albums:x,setAlbums:p}=l,f=d.filter(m=>m.albumId===e).map(m=>m.id);f.length>0&&await Promise.all(f.map(m=>g.delete(`/tracks/${m}`))),await g.delete(`/albums/${e}`),await U.delete(`/deleteAlbum/${encodeURIComponent(a.currentGroup.name)}/${encodeURIComponent(r)}`),p(x.filter(m=>m.id!==e)),u(d.filter(m=>m.albumId!==e)),c.success("Альбом и все его треки успешно удалены")}catch(e){c.error(e instanceof Error?e.message:"Ошибка при удалении альбома")}}async function ae(s,e){try{await g.patch(`/albums/${s}`,{description:e});const{albums:r,setAlbums:l}=b.getState();l(r.map(o=>o.id===s?{...o,description:e}:o)),c.success("Описание успешно обновлено")}catch(r){c.error(r instanceof Error?r.message:"Ошибка при обновлении описания")}}async function se(s,e,r){try{const l=new FormData;l.append("track",r);const o=await U.post(`/addTrack/${encodeURIComponent(s.name)}/${encodeURIComponent(e.name)}`,l,{headers:{"Content-Type":"multipart/form-data"}}),a=await Y(r),d={id:Z(),title:r.name.replace(/\.[^/.]+$/,""),duration:a,cover:e.cover??"",groupName:s.name,albumId:e.id,groupId:s.id,audioUrl:o.data.trackUrl,createdAt:new Date().toISOString()};return await Promise.all([g.post("/tracks",d),g.patch(`/albums/${e.id}`,{trackIds:[...e.trackIds??[],d.id]})]),$.getState().addTrack(d),c.success("Трек успешно добавлен"),o.data}catch(l){throw c.error(l instanceof Error?l.message:"Ошибка при добавлении трека"),l}}function re(){const s=V(),{t:e}=M("album"),{albumId:r}=J(),l=_(n=>n.authData?.likedAlbums??[]),o=O(n=>n.currentGroup),a=b(n=>n.currentAlbum),d=b(n=>n.setCurrentAlbum),[u,x]=i.useState(a?.description??""),[p,f]=i.useState(!1),[m,h]=i.useState(!1),[k,y]=i.useState(!1),j=i.useRef(null);i.useEffect(()=>{!a&&r&&o&&ee(o.id,r).catch(()=>c.error(e("loadAlbumError")))},[r,a,o]),i.useEffect(()=>{x(a?.description??"")},[a]);const v=i.useCallback(n=>{x(n)},[]),S=i.useCallback(()=>{if(!a?.id){c.error(e("albumNotSelected"));return}X(a.id)},[a?.id,e]),w=i.useCallback(async()=>{if(!(p||!a)){f(!0);try{await ae(a.id,u),y(!1)}catch{c.error(e("saveError"))}finally{f(!1)}}},[p,a,u,e]),I=i.useCallback(async()=>{if(!a){c.error(e("albumNotSelected"));return}try{await te(a),s("/my_group"),d(null),c.success(e("albumDeleted"))}catch{c.error(e("deleteError"))}finally{h(!1)}},[a,d,e]),A=i.useCallback(()=>{j.current?.click()},[]),D=i.useCallback(async n=>{const R=n.target.files;if(R?.length){if(!o||!a){c.error(e("albumOrGroupNotSelected")),n.target.value="";return}try{await se(o,a,R[0])}catch(P){c.error(e("uploadTrackError")),console.error(P)}finally{n.target.value=""}}},[o,a,e]),E=i.useCallback(n=>{h(n)},[]),T=i.useCallback(n=>{y(n)},[]);return i.useMemo(()=>({currentAlbum:a,desc:u,setDesc:v,saving:p,isDeleteModalOpen:m,setIsDeleteModalOpen:E,isEditing:k,setIsEditing:T,onSave:w,onDelete:I,fileInputRef:j,toggleAlbum:S,openFileDialog:A,onFileChange:D,likedAlbums:l}),[a,u,v,p,m,E,k,T,w,I,A,D,l])}const F=s=>{const e=new Date(s);return isNaN(+e)?"Invalid Date":new Intl.DateTimeFormat("ru-RU",{day:"numeric",month:"long",year:"numeric"}).format(e).replace(/ г\.$/," г.")},oe=()=>{const{t:s}=M("album"),{currentAlbum:e,desc:r,setDesc:l,saving:o,isDeleteModalOpen:a,setIsDeleteModalOpen:d,isEditing:u,setIsEditing:x,onSave:p,onDelete:f,fileInputRef:m,toggleAlbum:h,openFileDialog:k,onFileChange:y,likedAlbums:j}=re();if(!e)return t.jsx("div",{className:"p-4 text-center text-gray-500",children:s("notSelected")});const v=j.includes(e.id);return t.jsxs("div",{className:"relative flex flex-col gap-1 py-6 px-20 text-white min-h-[400px]",children:[t.jsx(C,{className:"absolute top-4 right-4 p-2 text-gray-400 hover:text-red-500 transition-colors",onClick:()=>d(!0),"aria-label":s("deleteAlbum"),children:t.jsx(L,{size:22})}),t.jsx(q,{isOpen:a,onClose:()=>d(!1),onConfirm:f}),t.jsxs("div",{className:"flex justify-between items-start gap-6 px-4 py-3 h-64",children:[t.jsxs("div",{className:"flex items-start gap-4 flex-shrink-0 max-w-xl",children:[t.jsx("img",{src:e.cover,alt:e.name,className:"w-64 h-64 object-cover rounded-md shadow-lg"}),t.jsxs("div",{className:"flex flex-col justify-center mt-15 max-w-[450px]",children:[t.jsx(N,{className:"text-4xl font-bold",children:e.name}),e.createdAt&&t.jsx(N,{className:"mt-4 text-gray-400 text-sm",children:s("created",{date:F(e.createdAt)})}),e.updatedAt&&t.jsx(N,{className:"text-gray-400 text-sm",children:s("updated",{date:F(e.updatedAt)})}),t.jsx("div",{className:"mt-4 flex items-start gap-2",children:u?t.jsxs(t.Fragment,{children:[t.jsx(K,{className:"flex-1 rounded-md p-2 text-black resize-y",value:r,onChange:S=>l(S.target.value),disabled:o}),t.jsx(C,{onClick:p,disabled:o,children:s(o?"saving":"save")})]}):t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[t.jsx(N,{className:"text-gray-300 whitespace-pre-wrap break-words",children:r||s("noDescription")}),t.jsx(C,{onClick:()=>x(!0),"aria-label":s("editDescription"),className:"text-gray-400 hover:text-white p-1 transition-colors",children:t.jsx(G,{size:20})})]})}),t.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[t.jsx(H,{theme:z.OUTLINE,albumForPlay:e,trackForPlay:null}),t.jsx(Q,{liked:v,onToggle:h})]})]})]}),t.jsxs("div",{className:"flex flex-col justify-end h-60",children:[t.jsx(C,{type:"button",onClick:k,children:s("uploadTrack")}),t.jsx("input",{type:"file",accept:"audio/*",ref:m,className:"hidden",onChange:y})]})]}),t.jsx("div",{className:"flex justify-center overflow-auto flex-grow mt-10 h-full",children:t.jsx(W,{albumId:e.id,albumName:e.name})})]})},Ie=B.memo(oe);export{Ie as A};
