import{r as f,j as t}from"./iframe-U8ya4lKj.js";import{u as C,R as b,a as A}from"./ButtonNavigation-COrRjsTF.js";import{G as R}from"./iconBase--zlYJr49.js";import{u as z}from"./GroupCover-BGBq_pSL.js";import{V as N,b as j,a as B}from"./api-BNB6Hzxt.js";import{u as D}from"./useTrackStore-OiNvfdpV.js";import{v as E}from"./v4-BKrj-4V8.js";import{u as I}from"./index.esm-BbXu7aDV.js";import{g as V}from"./getAudioDuration-BkZTS1fg.js";import{B as y,a as U,b as q}from"./Button-DE9W436l.js";import"./Dropdown-DwKt7Qhu.js";import{F as T}from"./FilePicker-CbYA0TGi.js";import{I as H}from"./Input-DaFUx77P.js";import"./Like-B3pHqG2f.js";import"./Loader-DiHYOjMw.js";import"./index-C84dbosL.js";import"./PageLoader-DRYwdG-o.js";import"./PageWrapper-CGXxUwgW.js";import"./PlayButton-DHaq6iyc.js";import{T as L}from"./Text-DVKAWUAM.js";import"./TrackControlButton-9SyhFgiT.js";import"./UserAvatar-QfRyJ_rf.js";import{u as G}from"./useTranslation-CSTQQmYg.js";async function M(e){return await N.promise((async()=>{if(!e.groupName)throw N.error("Группа не выбрана"),new Error("groupName is required");const{data:a}=await j.get("/groups",{params:{name:e.groupName}});if(!a.length)throw new Error(`Группа с именем "${e.groupName}" не найдена`);const m=a[0],r=new FormData;r.append("groupName",e.groupName),r.append("trackName",e.title),r.append("cover",e.cover),r.append("audio",e.audio);const s=await B.post("/uploadTrack",r,{headers:{"Content-Type":"multipart/form-data"}}),{coverUrl:l,audioUrl:n}=s.data,c={id:E(),title:e.title,duration:e.duration,cover:l,groupId:m.id,audioUrl:n,createdAt:new Date().toISOString()};await j.post("/tracks",c),D.getState().addTrack(c)})(),{loading:"Загрузка трека...",success:"Трек успешно добавлен",error:a=>a instanceof Error?a.message:"Ошибка при добавлении трека"})}function P(e){return R({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M256 64v225.1c-12.6-7.3-27.1-11.7-42.7-11.7-47.1 0-85.3 38.2-85.3 85.3s38.2 85.3 85.3 85.3 85.3-38.2 85.3-85.3V149.3H384V64H256z"},child:[]}]})(e)}function O(){const{register:e,handleSubmit:a,watch:m,setValue:r,formState:{errors:s}}=I(),l=z(o=>o.currentGroup?.name),[n,c]=f.useState(null),[d,i]=f.useState(null),[p,g]=f.useState(null),F=C();f.useEffect(()=>{e("cover",{required:!0}),e("audio",{required:!0}),e("title")},[e]);const x=(o,u)=>{if(!(!u||u.length===0))if(r(o,u,{shouldValidate:!0}),o==="cover")c(URL.createObjectURL(u[0]));else{const h=u[0];i(h.name),V(h).then(v=>{g(v)})}};return{register:e,watch:m,setValue:r,errors:s,coverPreview:n,audioSelected:!!d,audioFileName:d,onCoverChange:o=>x("cover",o),onAudioChange:o=>x("audio",o),submitHandler:o=>a(async({cover:u,audio:h,title:v})=>{const S=u[0],w=h[0],k=v?.trim()||w.name.replace(/\.[^/.]+$/,"");if(p==null){alert("Не удалось получить длительность аудио. Пожалуйста, подождите.");return}await M({title:k,cover:S,audio:w,duration:Math.round(p),groupName:l}),o?.(),F(-1)})}}const he=()=>{const{register:e,onCoverChange:a,onAudioChange:m,watch:r,errors:s,coverPreview:l,audioSelected:n,audioFileName:c,submitHandler:d}=O(),{t:i}=G("addTrackForm"),p=r("title");return t.jsxs("form",{onSubmit:g=>{g.preventDefault(),d()(g)},className:"flex flex-col gap-6 w-full max-w-md mx-auto",children:[t.jsxs("div",{className:"flex gap-4",children:[t.jsx(T,{accept:"image/*",onChange:a,previewUrl:l,placeholder:t.jsx(b,{size:48}),title:i("addCover")}),s.cover&&t.jsx("p",{className:"text-red-600 text-sm mt-1",children:i("coverRequired")}),t.jsx(T,{accept:"audio/mpeg",onChange:m,placeholder:n?t.jsx(P,{size:48}):t.jsx(A,{size:48}),title:i("addAudio"),active:n}),s.audio&&t.jsx("p",{className:"text-red-600 text-sm mt-1",children:i("audioRequired")})]}),t.jsx(H,{placeholder:i("trackTitle"),...e("title"),className:s.title?"border-red-600":""}),!p&&n&&t.jsxs(L,{className:"text-yellow-600 text-sm mt-1",size:"medium",children:[i("titleFromFile")," ",t.jsx("b",{children:c?.replace(/\.[^/.]+$/,"")})]}),t.jsx(y,{type:"submit",theme:q.OUTLINE,size:U.L,className:"self-center mt-2",children:i("addButton")})]})};export{he as A};
